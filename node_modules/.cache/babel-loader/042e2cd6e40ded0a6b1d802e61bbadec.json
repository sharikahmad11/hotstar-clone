{"ast":null,"code":"\"use strict\";\n/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = Object.setPrototypeOf || {\n    __proto__: []\n  } instanceof Array && function (d, b) {\n    d.__proto__ = b;\n  } || function (d, b) {\n    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar onDisconnect_1 = require(\"./onDisconnect\");\n\nvar TransactionResult_1 = require(\"./TransactionResult\");\n\nvar util_1 = require(\"../core/util/util\");\n\nvar NextPushId_1 = require(\"../core/util/NextPushId\");\n\nvar Query_1 = require(\"./Query\");\n\nvar Repo_1 = require(\"../core/Repo\");\n\nvar Path_1 = require(\"../core/util/Path\");\n\nvar QueryParams_1 = require(\"../core/view/QueryParams\");\n\nvar validation_1 = require(\"../core/util/validation\");\n\nvar util_2 = require(\"@firebase/util\");\n\nvar util_3 = require(\"@firebase/util\");\n\nvar SyncPoint_1 = require(\"../core/SyncPoint\");\n\nvar Reference =\n/** @class */\nfunction (_super) {\n  __extends(Reference, _super);\n  /**\n   * Call options:\n   *   new Reference(Repo, Path) or\n   *   new Reference(url: string, string|RepoManager)\n   *\n   * Externally - this is the firebase.database.Reference type.\n   *\n   * @param {!Repo} repo\n   * @param {(!Path)} path\n   * @extends {Query}\n   */\n\n\n  function Reference(repo, path) {\n    var _this = this;\n\n    if (!(repo instanceof Repo_1.Repo)) {\n      throw new Error('new Reference() no longer supported - use app.database().');\n    } // call Query's constructor, passing in the repo and path.\n\n\n    _this = _super.call(this, repo, path, QueryParams_1.QueryParams.DEFAULT, false) || this;\n    return _this;\n  }\n  /** @return {?string} */\n\n\n  Reference.prototype.getKey = function () {\n    util_2.validateArgCount('Reference.key', 0, 0, arguments.length);\n    if (this.path.isEmpty()) return null;else return this.path.getBack();\n  };\n  /**\n   * @param {!(string|Path)} pathString\n   * @return {!Reference}\n   */\n\n\n  Reference.prototype.child = function (pathString) {\n    util_2.validateArgCount('Reference.child', 1, 1, arguments.length);\n\n    if (typeof pathString === 'number') {\n      pathString = String(pathString);\n    } else if (!(pathString instanceof Path_1.Path)) {\n      if (this.path.getFront() === null) validation_1.validateRootPathString('Reference.child', 1, pathString, false);else validation_1.validatePathString('Reference.child', 1, pathString, false);\n    }\n\n    return new Reference(this.repo, this.path.child(pathString));\n  };\n  /** @return {?Reference} */\n\n\n  Reference.prototype.getParent = function () {\n    util_2.validateArgCount('Reference.parent', 0, 0, arguments.length);\n    var parentPath = this.path.parent();\n    return parentPath === null ? null : new Reference(this.repo, parentPath);\n  };\n  /** @return {!Reference} */\n\n\n  Reference.prototype.getRoot = function () {\n    util_2.validateArgCount('Reference.root', 0, 0, arguments.length);\n    var ref = this;\n\n    while (ref.getParent() !== null) {\n      ref = ref.getParent();\n    }\n\n    return ref;\n  };\n  /** @return {!Database} */\n\n\n  Reference.prototype.databaseProp = function () {\n    return this.repo.database;\n  };\n  /**\n   * @param {*} newVal\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n\n\n  Reference.prototype.set = function (newVal, onComplete) {\n    util_2.validateArgCount('Reference.set', 1, 2, arguments.length);\n    validation_1.validateWritablePath('Reference.set', this.path);\n    validation_1.validateFirebaseDataArg('Reference.set', 1, newVal, this.path, false);\n    util_2.validateCallback('Reference.set', 2, onComplete, true);\n    var deferred = new util_3.Deferred();\n    this.repo.setWithPriority(this.path, newVal,\n    /*priority=*/\n    null, deferred.wrapCallback(onComplete));\n    return deferred.promise;\n  };\n  /**\n   * @param {!Object} objectToMerge\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n\n\n  Reference.prototype.update = function (objectToMerge, onComplete) {\n    util_2.validateArgCount('Reference.update', 1, 2, arguments.length);\n    validation_1.validateWritablePath('Reference.update', this.path);\n\n    if (Array.isArray(objectToMerge)) {\n      var newObjectToMerge = {};\n\n      for (var i = 0; i < objectToMerge.length; ++i) {\n        newObjectToMerge['' + i] = objectToMerge[i];\n      }\n\n      objectToMerge = newObjectToMerge;\n      util_1.warn('Passing an Array to Firebase.update() is deprecated. ' + 'Use set() if you want to overwrite the existing data, or ' + 'an Object with integer keys if you really do want to ' + 'only update some of the children.');\n    }\n\n    validation_1.validateFirebaseMergeDataArg('Reference.update', 1, objectToMerge, this.path, false);\n    util_2.validateCallback('Reference.update', 2, onComplete, true);\n    var deferred = new util_3.Deferred();\n    this.repo.update(this.path, objectToMerge, deferred.wrapCallback(onComplete));\n    return deferred.promise;\n  };\n  /**\n   * @param {*} newVal\n   * @param {string|number|null} newPriority\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n\n\n  Reference.prototype.setWithPriority = function (newVal, newPriority, onComplete) {\n    util_2.validateArgCount('Reference.setWithPriority', 2, 3, arguments.length);\n    validation_1.validateWritablePath('Reference.setWithPriority', this.path);\n    validation_1.validateFirebaseDataArg('Reference.setWithPriority', 1, newVal, this.path, false);\n    validation_1.validatePriority('Reference.setWithPriority', 2, newPriority, false);\n    util_2.validateCallback('Reference.setWithPriority', 3, onComplete, true);\n    if (this.getKey() === '.length' || this.getKey() === '.keys') throw 'Reference.setWithPriority failed: ' + this.getKey() + ' is a read-only object.';\n    var deferred = new util_3.Deferred();\n    this.repo.setWithPriority(this.path, newVal, newPriority, deferred.wrapCallback(onComplete));\n    return deferred.promise;\n  };\n  /**\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n\n\n  Reference.prototype.remove = function (onComplete) {\n    util_2.validateArgCount('Reference.remove', 0, 1, arguments.length);\n    validation_1.validateWritablePath('Reference.remove', this.path);\n    util_2.validateCallback('Reference.remove', 1, onComplete, true);\n    return this.set(null, onComplete);\n  };\n  /**\n   * @param {function(*):*} transactionUpdate\n   * @param {(function(?Error, boolean, ?DataSnapshot))=} onComplete\n   * @param {boolean=} applyLocally\n   * @return {!Promise}\n   */\n\n\n  Reference.prototype.transaction = function (transactionUpdate, onComplete, applyLocally) {\n    util_2.validateArgCount('Reference.transaction', 1, 3, arguments.length);\n    validation_1.validateWritablePath('Reference.transaction', this.path);\n    util_2.validateCallback('Reference.transaction', 1, transactionUpdate, false);\n    util_2.validateCallback('Reference.transaction', 2, onComplete, true); // NOTE: applyLocally is an internal-only option for now.  We need to decide if we want to keep it and how\n    // to expose it.\n\n    validation_1.validateBoolean('Reference.transaction', 3, applyLocally, true);\n    if (this.getKey() === '.length' || this.getKey() === '.keys') throw 'Reference.transaction failed: ' + this.getKey() + ' is a read-only object.';\n    if (applyLocally === undefined) applyLocally = true;\n    var deferred = new util_3.Deferred();\n\n    if (typeof onComplete === 'function') {\n      deferred.promise.catch(function () {});\n    }\n\n    var promiseComplete = function (error, committed, snapshot) {\n      if (error) {\n        deferred.reject(error);\n      } else {\n        deferred.resolve(new TransactionResult_1.TransactionResult(committed, snapshot));\n      }\n\n      if (typeof onComplete === 'function') {\n        onComplete(error, committed, snapshot);\n      }\n    };\n\n    this.repo.startTransaction(this.path, transactionUpdate, promiseComplete, applyLocally);\n    return deferred.promise;\n  };\n  /**\n   * @param {string|number|null} priority\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n\n\n  Reference.prototype.setPriority = function (priority, onComplete) {\n    util_2.validateArgCount('Reference.setPriority', 1, 2, arguments.length);\n    validation_1.validateWritablePath('Reference.setPriority', this.path);\n    validation_1.validatePriority('Reference.setPriority', 1, priority, false);\n    util_2.validateCallback('Reference.setPriority', 2, onComplete, true);\n    var deferred = new util_3.Deferred();\n    this.repo.setWithPriority(this.path.child('.priority'), priority, null, deferred.wrapCallback(onComplete));\n    return deferred.promise;\n  };\n  /**\n   * @param {*=} value\n   * @param {function(?Error)=} onComplete\n   * @return {!Reference}\n   */\n\n\n  Reference.prototype.push = function (value, onComplete) {\n    util_2.validateArgCount('Reference.push', 0, 2, arguments.length);\n    validation_1.validateWritablePath('Reference.push', this.path);\n    validation_1.validateFirebaseDataArg('Reference.push', 1, value, this.path, true);\n    util_2.validateCallback('Reference.push', 2, onComplete, true);\n    var now = this.repo.serverTime();\n    var name = NextPushId_1.nextPushId(now); // push() returns a ThennableReference whose promise is fulfilled with a regular Reference.\n    // We use child() to create handles to two different references. The first is turned into a\n    // ThennableReference below by adding then() and catch() methods and is used as the\n    // return value of push(). The second remains a regular Reference and is used as the fulfilled\n    // value of the first ThennableReference.\n\n    var thennablePushRef = this.child(name);\n    var pushRef = this.child(name);\n    var promise;\n\n    if (value != null) {\n      promise = thennablePushRef.set(value, onComplete).then(function () {\n        return pushRef;\n      });\n    } else {\n      promise = Promise.resolve(pushRef);\n    }\n\n    thennablePushRef.then = promise.then.bind(promise);\n    thennablePushRef.catch = promise.then.bind(promise, undefined);\n\n    if (typeof onComplete === 'function') {\n      promise.catch(function () {});\n    }\n\n    return thennablePushRef;\n  };\n  /**\n   * @return {!OnDisconnect}\n   */\n\n\n  Reference.prototype.onDisconnect = function () {\n    validation_1.validateWritablePath('Reference.onDisconnect', this.path);\n    return new onDisconnect_1.OnDisconnect(this.repo, this.path);\n  };\n\n  Object.defineProperty(Reference.prototype, \"database\", {\n    get: function () {\n      return this.databaseProp();\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(Reference.prototype, \"key\", {\n    get: function () {\n      return this.getKey();\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(Reference.prototype, \"parent\", {\n    get: function () {\n      return this.getParent();\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(Reference.prototype, \"root\", {\n    get: function () {\n      return this.getRoot();\n    },\n    enumerable: true,\n    configurable: true\n  });\n  return Reference;\n}(Query_1.Query);\n\nexports.Reference = Reference;\n/**\n * Define reference constructor in various modules\n *\n * We are doing this here to avoid several circular\n * dependency issues\n */\n\nQuery_1.Query.__referenceConstructor = Reference;\nSyncPoint_1.SyncPoint.__referenceConstructor = Reference;","map":{"version":3,"sources":["../src/api/Reference.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { OnDisconnect } from './onDisconnect';\nimport { TransactionResult } from './TransactionResult';\nimport { warn } from '../core/util/util';\nimport { nextPushId } from '../core/util/NextPushId';\nimport { Query } from './Query';\nimport { Repo } from '../core/Repo';\nimport { Path } from '../core/util/Path';\nimport { QueryParams } from '../core/view/QueryParams';\nimport {\n  validateRootPathString,\n  validatePathString,\n  validateFirebaseMergeDataArg,\n  validateBoolean,\n  validatePriority,\n  validateFirebaseDataArg,\n  validateWritablePath\n} from '../core/util/validation';\nimport { validateArgCount, validateCallback } from '@firebase/util';\nimport { Deferred } from '@firebase/util';\nimport { SyncPoint } from '../core/SyncPoint';\nimport { Database } from './Database';\nimport { DataSnapshot } from './DataSnapshot';\n\nexport interface ReferenceConstructor {\n  new (repo: Repo, path: Path): Reference;\n}\n\nexport class Reference extends Query {\n  public then: (a?: any) => Promise<any>;\n  public catch: (a?: Error) => Promise<any>;\n\n  /**\n   * Call options:\n   *   new Reference(Repo, Path) or\n   *   new Reference(url: string, string|RepoManager)\n   *\n   * Externally - this is the firebase.database.Reference type.\n   *\n   * @param {!Repo} repo\n   * @param {(!Path)} path\n   * @extends {Query}\n   */\n  constructor(repo: Repo, path: Path) {\n    if (!(repo instanceof Repo)) {\n      throw new Error(\n        'new Reference() no longer supported - use app.database().'\n      );\n    }\n\n    // call Query's constructor, passing in the repo and path.\n    super(repo, path, QueryParams.DEFAULT, false);\n  }\n\n  /** @return {?string} */\n  getKey(): string | null {\n    validateArgCount('Reference.key', 0, 0, arguments.length);\n\n    if (this.path.isEmpty()) return null;\n    else return this.path.getBack();\n  }\n\n  /**\n   * @param {!(string|Path)} pathString\n   * @return {!Reference}\n   */\n  child(pathString: string | Path): Reference {\n    validateArgCount('Reference.child', 1, 1, arguments.length);\n    if (typeof pathString === 'number') {\n      pathString = String(pathString);\n    } else if (!(pathString instanceof Path)) {\n      if (this.path.getFront() === null)\n        validateRootPathString('Reference.child', 1, pathString, false);\n      else validatePathString('Reference.child', 1, pathString, false);\n    }\n\n    return new Reference(this.repo, this.path.child(pathString));\n  }\n\n  /** @return {?Reference} */\n  getParent(): Reference | null {\n    validateArgCount('Reference.parent', 0, 0, arguments.length);\n\n    const parentPath = this.path.parent();\n    return parentPath === null ? null : new Reference(this.repo, parentPath);\n  }\n\n  /** @return {!Reference} */\n  getRoot(): Reference {\n    validateArgCount('Reference.root', 0, 0, arguments.length);\n\n    let ref = this as any;\n    while (ref.getParent() !== null) {\n      ref = ref.getParent();\n    }\n    return ref;\n  }\n\n  /** @return {!Database} */\n  databaseProp(): Database {\n    return this.repo.database;\n  }\n\n  /**\n   * @param {*} newVal\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n  set(newVal: any, onComplete?: (a: Error | null) => void): Promise<any> {\n    validateArgCount('Reference.set', 1, 2, arguments.length);\n    validateWritablePath('Reference.set', this.path);\n    validateFirebaseDataArg('Reference.set', 1, newVal, this.path, false);\n    validateCallback('Reference.set', 2, onComplete, true);\n\n    const deferred = new Deferred();\n    this.repo.setWithPriority(\n      this.path,\n      newVal,\n      /*priority=*/ null,\n      deferred.wrapCallback(onComplete)\n    );\n    return deferred.promise;\n  }\n\n  /**\n   * @param {!Object} objectToMerge\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n  update(\n    objectToMerge: Object,\n    onComplete?: (a: Error | null) => void\n  ): Promise<any> {\n    validateArgCount('Reference.update', 1, 2, arguments.length);\n    validateWritablePath('Reference.update', this.path);\n\n    if (Array.isArray(objectToMerge)) {\n      const newObjectToMerge: { [k: string]: any } = {};\n      for (let i = 0; i < objectToMerge.length; ++i) {\n        newObjectToMerge['' + i] = objectToMerge[i];\n      }\n      objectToMerge = newObjectToMerge;\n      warn(\n        'Passing an Array to Firebase.update() is deprecated. ' +\n          'Use set() if you want to overwrite the existing data, or ' +\n          'an Object with integer keys if you really do want to ' +\n          'only update some of the children.'\n      );\n    }\n    validateFirebaseMergeDataArg(\n      'Reference.update',\n      1,\n      objectToMerge,\n      this.path,\n      false\n    );\n    validateCallback('Reference.update', 2, onComplete, true);\n    const deferred = new Deferred();\n    this.repo.update(\n      this.path,\n      objectToMerge,\n      deferred.wrapCallback(onComplete)\n    );\n    return deferred.promise;\n  }\n\n  /**\n   * @param {*} newVal\n   * @param {string|number|null} newPriority\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n  setWithPriority(\n    newVal: any,\n    newPriority: string | number | null,\n    onComplete?: (a: Error | null) => void\n  ): Promise<any> {\n    validateArgCount('Reference.setWithPriority', 2, 3, arguments.length);\n    validateWritablePath('Reference.setWithPriority', this.path);\n    validateFirebaseDataArg(\n      'Reference.setWithPriority',\n      1,\n      newVal,\n      this.path,\n      false\n    );\n    validatePriority('Reference.setWithPriority', 2, newPriority, false);\n    validateCallback('Reference.setWithPriority', 3, onComplete, true);\n\n    if (this.getKey() === '.length' || this.getKey() === '.keys')\n      throw 'Reference.setWithPriority failed: ' +\n        this.getKey() +\n        ' is a read-only object.';\n\n    const deferred = new Deferred();\n    this.repo.setWithPriority(\n      this.path,\n      newVal,\n      newPriority,\n      deferred.wrapCallback(onComplete)\n    );\n    return deferred.promise;\n  }\n\n  /**\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n  remove(onComplete?: (a: Error | null) => void): Promise<any> {\n    validateArgCount('Reference.remove', 0, 1, arguments.length);\n    validateWritablePath('Reference.remove', this.path);\n    validateCallback('Reference.remove', 1, onComplete, true);\n\n    return this.set(null, onComplete);\n  }\n\n  /**\n   * @param {function(*):*} transactionUpdate\n   * @param {(function(?Error, boolean, ?DataSnapshot))=} onComplete\n   * @param {boolean=} applyLocally\n   * @return {!Promise}\n   */\n  transaction(\n    transactionUpdate: (a: any) => any,\n    onComplete?: (a: Error | null, b: boolean, c: DataSnapshot | null) => void,\n    applyLocally?: boolean\n  ): Promise<TransactionResult> {\n    validateArgCount('Reference.transaction', 1, 3, arguments.length);\n    validateWritablePath('Reference.transaction', this.path);\n    validateCallback('Reference.transaction', 1, transactionUpdate, false);\n    validateCallback('Reference.transaction', 2, onComplete, true);\n    // NOTE: applyLocally is an internal-only option for now.  We need to decide if we want to keep it and how\n    // to expose it.\n    validateBoolean('Reference.transaction', 3, applyLocally, true);\n\n    if (this.getKey() === '.length' || this.getKey() === '.keys')\n      throw 'Reference.transaction failed: ' +\n        this.getKey() +\n        ' is a read-only object.';\n\n    if (applyLocally === undefined) applyLocally = true;\n\n    const deferred = new Deferred<TransactionResult>();\n    if (typeof onComplete === 'function') {\n      deferred.promise.catch(() => {});\n    }\n\n    const promiseComplete = function(\n      error: Error,\n      committed: boolean,\n      snapshot: DataSnapshot\n    ) {\n      if (error) {\n        deferred.reject(error);\n      } else {\n        deferred.resolve(new TransactionResult(committed, snapshot));\n      }\n      if (typeof onComplete === 'function') {\n        onComplete(error, committed, snapshot);\n      }\n    };\n    this.repo.startTransaction(\n      this.path,\n      transactionUpdate,\n      promiseComplete,\n      applyLocally\n    );\n\n    return deferred.promise;\n  }\n\n  /**\n   * @param {string|number|null} priority\n   * @param {function(?Error)=} onComplete\n   * @return {!Promise}\n   */\n  setPriority(\n    priority: string | number | null,\n    onComplete?: (a: Error | null) => void\n  ): Promise<any> {\n    validateArgCount('Reference.setPriority', 1, 2, arguments.length);\n    validateWritablePath('Reference.setPriority', this.path);\n    validatePriority('Reference.setPriority', 1, priority, false);\n    validateCallback('Reference.setPriority', 2, onComplete, true);\n\n    const deferred = new Deferred();\n    this.repo.setWithPriority(\n      this.path.child('.priority'),\n      priority,\n      null,\n      deferred.wrapCallback(onComplete)\n    );\n    return deferred.promise;\n  }\n\n  /**\n   * @param {*=} value\n   * @param {function(?Error)=} onComplete\n   * @return {!Reference}\n   */\n  push(value?: any, onComplete?: (a: Error | null) => void): Reference {\n    validateArgCount('Reference.push', 0, 2, arguments.length);\n    validateWritablePath('Reference.push', this.path);\n    validateFirebaseDataArg('Reference.push', 1, value, this.path, true);\n    validateCallback('Reference.push', 2, onComplete, true);\n\n    const now = this.repo.serverTime();\n    const name = nextPushId(now);\n\n    // push() returns a ThennableReference whose promise is fulfilled with a regular Reference.\n    // We use child() to create handles to two different references. The first is turned into a\n    // ThennableReference below by adding then() and catch() methods and is used as the\n    // return value of push(). The second remains a regular Reference and is used as the fulfilled\n    // value of the first ThennableReference.\n    const thennablePushRef = this.child(name);\n    const pushRef = this.child(name);\n\n    let promise;\n    if (value != null) {\n      promise = thennablePushRef.set(value, onComplete).then(() => pushRef);\n    } else {\n      promise = Promise.resolve(pushRef);\n    }\n\n    thennablePushRef.then = promise.then.bind(promise);\n    thennablePushRef.catch = promise.then.bind(promise, undefined);\n\n    if (typeof onComplete === 'function') {\n      promise.catch(() => {});\n    }\n\n    return thennablePushRef;\n  }\n\n  /**\n   * @return {!OnDisconnect}\n   */\n  onDisconnect(): OnDisconnect {\n    validateWritablePath('Reference.onDisconnect', this.path);\n    return new OnDisconnect(this.repo, this.path);\n  }\n\n  get database(): Database {\n    return this.databaseProp();\n  }\n\n  get key(): string | null {\n    return this.getKey();\n  }\n\n  get parent(): Reference | null {\n    return this.getParent();\n  }\n\n  get root(): Reference {\n    return this.getRoot();\n  }\n}\n\n/**\n * Define reference constructor in various modules\n *\n * We are doing this here to avoid several circular\n * dependency issues\n */\nQuery.__referenceConstructor = Reference;\nSyncPoint.__referenceConstructor = Reference;\n"]},"metadata":{},"sourceType":"script"}